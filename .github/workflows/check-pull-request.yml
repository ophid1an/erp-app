name: Check pull request

on: pull_request

jobs:
  prettier:
    name: Prettier
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Compute changed files
        id: changed
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }} --depth=1
          mapfile -t FILES < <(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...${{ github.event.pull_request.head.sha }} -- \
            'src/**/*.{ts,js,vue,css,md,json}' '*.json' '*.md' '*.prettierrc' '.prettierrc.*' '.github/**/*.yml' '.github/**/*.yaml')
          if [ ${#FILES[@]} -eq 0 ]; then
            echo "No relevant files changed."
            echo "changed_files=" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          printf '%s\n' "${FILES[@]}" > changed_files.txt
          {
            echo "changed_files<<EOF"
            printf '%s\n' "${FILES[@]}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Run Prettier check
        id: prettier_check
        if: steps.changed.outputs.changed_files != ''
        continue-on-error: true
        run: |
          echo "Checking files:"
          cat changed_files.txt
          mapfile -t FILES < changed_files.txt
          npx prettier --check "${FILES[@]}"

      - name: Generate Prettier patch (on failure)
        if: steps.changed.outputs.changed_files != '' && steps.prettier_check.outcome == 'failure'
        run: |
          mapfile -t FILES < changed_files.txt
          npx prettier --write "${FILES[@]}"
          git diff --patch > prettier-fixes.patch
          echo "patch_path=prettier-fixes.patch" >> "$GITHUB_ENV"

      - name: Upload Prettier patch artifact
        if: env.patch_path != ''
        uses: actions/upload-artifact@v4
        with:
          name: prettier-fixes
          path: ${{ env.patch_path }}

      - name: Skip Prettier (no matching changes)
        if: steps.changed.outputs.changed_files == ''
        run: echo "Skipping Prettier check; no matching files changed."

      - name: Summarize Prettier result
        if: always()
        run: |
          {
            echo "### Prettier status"
            if [ "${{ steps.changed.outputs.changed_files }}" = "" ]; then
              echo "- Skipped: no matching files changed."
            else
              if [ "${{ steps.prettier_check.outcome || 'success' }}" = "success" ]; then
                echo "- ✅ Passed on changed files."
              else
                echo "- ❌ Failed. Run \`npm run prettier:write\` locally or apply the attached patch artifact."
                if [ -n "${{ env.patch_path }}" ]; then
                  echo "  - Patch artifact: prettier-fixes"
                fi
              fi
              echo ""
              echo "Changed files checked:"
              echo '```'
              printf '%s\n' "${{ steps.changed.outputs.changed_files }}"
              echo '```'
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Fail if Prettier failed
        if: steps.prettier_check.outcome == 'failure'
        run: exit 1

  build-php-image:
    name: Build-php-image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Make Docker cache directory
        run: mkdir -p /tmp/.docker-cache

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.docker-cache/php
          key: ${{ runner.os }}-docker-${{ hashFiles('Dockerfile.php', 'composer.lock') }}
          restore-keys: ${{ runner.os }}-docker-

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and export erp-php
        uses: docker/build-push-action@v6
        with:
          tags: erp-php
          outputs: type=docker,dest=/tmp/erp-php.tar
          file: Dockerfile.php
          cache-from: type=local,src=/tmp/.docker-cache/php
          cache-to: type=local,dest=/tmp/.docker-cache/php,mode=max
          target: dev

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: erp-php
          path: /tmp/erp-php.tar

  build-node-image:
    name: Build-node-image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Make Docker cache directory
        run: mkdir -p /tmp/.docker-cache

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.docker-cache/node
          key: ${{ runner.os }}-docker-${{ hashFiles('Dockerfile.node', 'package-lock.json') }}
          restore-keys: ${{ runner.os }}-docker-

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and export erp-node
        uses: docker/build-push-action@v6
        with:
          tags: erp-node
          outputs: type=docker,dest=/tmp/erp-node.tar
          file: Dockerfile.node
          cache-from: type=local,src=/tmp/.docker-cache/node
          cache-to: type=local,dest=/tmp/.docker-cache/node,mode=max
          target: dev

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: erp-node
          path: /tmp/erp-node.tar

  audit-php-image:
    needs: build-php-image
    runs-on: ubuntu-latest

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: erp-php
          path: /tmp

      - name: Load image
        run: |
          docker load --input /tmp/erp-php.tar

      - name: Run PHPStan
        run: docker run --rm erp-php php -d memory_limit=1G vendor/bin/phpstan

      - name: Audit composer
        run: docker run --rm erp-php composer audit

  audit-node-image:
    needs: build-node-image
    runs-on: ubuntu-latest

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: erp-node
          path: /tmp

      - name: Load image
        run: |
          docker load --input /tmp/erp-node.tar

      - name: Audit npm
        run: docker run --rm erp-node npm audit --omit dev --audit-level=high
